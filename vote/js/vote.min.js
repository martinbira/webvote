$(document).on("pageinit","#votepage",function(c){var b=$("#statusdiv");var d=$("#sysbar");d.hide();$(".error").hide();$("#vote_code").focus();if(supports_html5_storage()){var a=localStorage.vote_code;if(a!=""){$("#vote_code").val(a)}}votejs.init();$("#vote_code").on("keyup",function(h){var g=$(this).val();if(g.length<3){b.html('<div class="infobar infobar-neutral" data-mini="true">Välkommen! ange först din röstkod.</div>');return false}else{var f="<img src='js/loading.gif'  alt='loading...' />";b.html(f);votejs.reread()}return false});$("#statform_trigger").on("submit",function(f){f.preventDefault();$(".error").hide();votejs.statFormEval(this)});$(".voteform_trigger").on("submit",function(f){f.preventDefault();$(".error").hide();votejs.voteFormEval(this)})});function supports_html5_storage(){try{return"localStorage" in window&&window.localStorage!==null}catch(a){return false}}function printInfobar(c,b,a){if(a.length>0){if(b=="ok"||b=="ok-cached"){$(c).html('<div class="infobar infobar-ok" data-mini="true">'+a+"</div>")}else{if(b=="neutral"){$(c).html('<div class="infobar infobar-neutral" data-mini="true">'+a+"</div>")}else{if(b=="warning"){$(c).html('<div class="infobar infobar-warning" data-mini="true">'+a+"</div>")}else{if(b=="error"){$(c).html('<div class="infobar infobar-error" data-mini="true">'+a+"</div>")}}}}$(c).show()}}votejs=function(){var e=false;var k=true;var m=0;var c=true;var b=0;var g=false;var d=false;var p=9999;var l=null;var h=[];function j(){$.ajax({type:"POST",url:"./php/jssettings.php",dataType:"json",cache:false,async:false,data:{operation:"getjssettings",source:"index.php",subset:""},success:function(r){if(r.msgtype=="ok"){e=r.CONST_SYS_JS_DEBUG;k=r.DISABLE_CLIENT_CHECKS;d=r.REQUEST_SYSSTATUS;p=r.SETTING_SYSSTATUS_INTERVAL;m=r.CONST_SETTING_VOTES_PER_CATEGORY_SAME;c=r.CONST_SETTING_VOTES_PER_CATEGORY_SAME_REQUIRE_ALL;b=r.CONST_SETTING_VOTES_PER_CATEGORY;g=r.CONST_SETTING_VOTES_PER_CATEGORY_REQUIRE_ALL;if(e){console.log(r)}h=r.CONST_SETTING_CATEGORIES_SYS;var s=r.SETTING_COMPETITION_NAME;$("#competition_header").text(s)}else{printInfobar("#statusdiv","warning","serverfel 1-1")}},error:function(t,r,s){printInfobar("#statusdiv","warning","serverfel 1-2")}})}function f(){$.ajax({type:"POST",url:"./php/vote_ajax.php",dataType:"json",cache:false,data:{operation:"reread",source:"index.php",vote_code:$("#vote_code").val()},success:function(r){if(e){console.log(r)}var s=true;if(r.msgtype=="ok"){$("#vote_code").val(r.vote_code);if(supports_html5_storage()){localStorage.vote_code=r.vote_code}s=false}else{if(r.msgtype=="ok-cached"){if(supports_html5_storage()){localStorage.vote_code=r.vote_code}s=false}}if(r.usrmsg!=null){printInfobar("#statusdiv",r.msgtype,r.usrmsg)}$.each(h,function(u,v){for(i=1;i<=b;i++){$("#"+v+"_vote"+i).prop("disabled",s);$("#"+v+"_vote"+i).val(r["vote_"+i+"_"+v])}});$("#submit_stat").prop("disabled",s);var t=$(".error");t.html("");t.hide()},error:function(t,r,s){if(e){alert("serverfel, reread: "+r+t+s)}}})}function o(r){if(d==true){$.ajax({type:"POST",url:"./php/vote_ajax.php",dataType:"json",cache:false,data:{operation:"sysstatus",source:"index.php",my_interval:p},success:function(s){if(e){console.log(s)}if(s.msgtype=="interval"&&l!=null){clearInterval(l);p=s.interval;l=window.setInterval(o,s.interval)}else{if(s.msgtype=="stop"){$("#sysbar").hide();d=false}else{if(s.usrmsg.length>0){printInfobar("#sysbar",s.msgtype,s.usrmsg)}else{$("#sysbar").hide()}}}},error:function(u,s,t){}})}}function a(t){var y=$(t);var G=$("#vote_code").val();var r=$(".vote_category",y).attr("id").toLowerCase();var B=$(".formstatus_trigger",y);var F=[];var x=false;var A=0;$("li",y).each(function(){var I=$(this).find("input");if(I!=null){var v=I.val();if(typeof v!="undefined"){if(v!=null&&v.length!=3&&v.length>0){x=true;var H=$(this).find(".error");if(H!=null){H.html("Tre siffror förväntas");H.slideDown()}else{if(e){console.log("check html, missing an error tag for "+r)}}}else{if(v!=null&&v.length!=0){A++}}F.push(v)}}});if(!k){if(m!=-1||g){var z=F.slice(0);var w=1;var E=1;var C=false;while(z.length>0){var D=z.pop();var u;if(D!=""){while(z.length>0&&(u=z.indexOf(D))!=-1){w++;z.splice(u,1)}if(w>E){E=w}w=1}else{if(g===true){C=true}}}if(C){x=true;B.html("Alla röster måste fyllas i, försök igen");B.fadeToggle()}if(E>m&&m!=-1){x=true;if(m==1){B.html("Du kan bara rösta "+m+" gång på samma öl")}else{B.html("Du kan rösta max "+m+" gånger på samma öl")}B.fadeToggle()}else{if(E>1&&A!=b&&c==true){x=true;B.html("Alla "+b+" röster måste fyllas om du röstar +1 gång på samma öl");B.fadeToggle()}}}}if(x){return false}var s={vote_code:G,category:r,operation:"post_vote",source:"index.php"};$.each(F,function(H,v){s["vote_"+(H+1)]=v});$.ajax({type:"POST",url:"./php/vote_ajax.php",dataType:"html",cache:false,data:s,success:function(v){if(e){console.log(v)}B.html(v);B.fadeToggle()},error:function(I,v,H){if(e){console.log("error, post_vote:"+I+","+v+","+H)}B.html("serverfel: "+v);B.fadeToggle()}});return false}function n(v){var t=$(v);var y=$(".formstatus_trigger",t);var x=$('input[name="stat1"]:checked',t).val();var u=$("#stat2",t).val();var s=$("#stat3",t).val();var w=$('input[name="stat4"]:checked',t).val();var r=$("#vote_code").val();$.ajax({type:"POST",url:"./php/vote_ajax.php",dataType:"html",cache:false,data:{vote_code:r,gender:x,age:u,location:s,firstSM:w,operation:"post_stat",source:"index.php"},success:function(z){if(e){console.log(z)}y.html(z);y.fadeToggle()},error:function(B,z,A){if(e){console.log("error, post_vote:"+B+","+z+","+A)}y.html("serverfel: "+z);y.fadeToggle()}});return false}function q(){j();f();l=window.setInterval(o,p);o()}return{init:q,reread:f,sysstatus:o,voteFormEval:a,statFormEval:n}}();